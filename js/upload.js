ymq_define("Upload",["jquery"],(function(t){return class e{constructor(){this.instance=null,this.init()}init(){this.disabledFileInput().initMemberVariables().initModal().initOptions().registerEvent(),this.registerFileInputChangeEvent()}initMemberVariables(){var t=this;return t.cropper=null,t.files=null,t.num=0,t.fileData={},t.rectangleRatios=[],t.formData=new FormData,t.inputDom=null,t.previewReady=!1,t.imgDom=null,t}disabledFileInput(){return t(document).on("click",".ymq_upload_new.ymq_disabled",(function(t){return t.stopImmediatePropagation(),t.preventDefault(),!1})),this}initOptions(){var e=this;return e.options={ready:function(){var i=this.cloneNode();i.className="",i.style.cssText="display: block;width: 100%;min-width: 0;min-height: 0;max-width: none;max-height: none;",t(".ymq-img-review")[0].appendChild(i.cloneNode()),e.previewReady=!0},dragMode:"move",isRound:!1,crop:function(i){if(e.previewReady){var a=i.detail,n=this.cropper.getImageData(),o=a.width/a.height,m=t(".ymq-img-review")[0];if(m){var d=m.getElementsByTagName("img").item(0),l=m.offsetWidth,s=l/o,r=a.width/l;m.style.height=s+"px",d&&(d.style.width=n.naturalWidth/r+"px",d.style.height=n.naturalHeight/r+"px",d.style.marginLeft=-a.x/r+"px",d.style.marginTop=-a.y/r+"px")}}}},e}resetAspectRatio(t){var e=this;return 2==(t=t.split(":")).length?(t=t[0]/t[1],e.options.aspectRatio=t):delete e.options.aspectRatio,e}registerEvent(){var e=this;return t(document).on("click",".ymq-cropper-button-resize",(function(){e.destroyCropper().resetAspectRatio(t(this).data("aspect-ratio")).newCropper()})),t(document).on("click",".ymq-cropper-rotate-left",(function(){e.cropper.rotate(-30)})),t(document).on("click",".ymq-cropper-rotate-right",(function(){e.cropper.rotate(30)})),e.modal.find("#ymq-do-cropper").on("click",(function(){if(e.cropper){e.getCanvas().toDataURL("image/jpeg",1);e.getCanvas().toBlob((function(t){e.addImg(t)}))}})),e}destroyCropper(){var t=this;return t.cropper.destroy(),t.cropper=null,t}newCropper(){var t=this;return t.cropper=new Cropper(t.imgDom[0],t.options),t.modal.resize(),t}initRectangleRatio(){var e=this;e.rectangleRatios=[],e.resetAspectRatio("");var i=e.inputDom.data("rectangle-ratio");i&&(i=i.split(",")).length>0&&(e.rectangleRatios=i,e.resetAspectRatio(e.rectangleRatios[0])),e.options.isRound=!1,t(".ymq-img-container").removeClass("cropper-container-round"),2==e.inputDom.data("cropper")&&(e.resetAspectRatio("1:1"),t(".ymq-img-container").addClass("cropper-container-round"));var a="";return e.rectangleRatios.forEach((function(t){a+=`<div class="ymq-cropper-button ymq-cropper-button-resize" data-aspect-ratio="${t}">${t}</div>`})),e.modal.find(".ymq-img-action_m").html(a),e.modal.find(".ymq-img-action_pc").html(a),e}getCanvas(){var t=this;if(2==t.inputDom.data("cropper")){var e=t.cropper.getCroppedCanvas(),i=document.createElement("canvas"),a=i.getContext("2d"),n=e.width,o=e.height;return i.width=n,i.height=o,a.imageSmoothingEnabled=!0,a.drawImage(e,0,0,n,o),a.globalCompositeOperation="destination-in",a.beginPath(),a.arc(n/2,o/2,Math.min(n,o)/2,0,2*Math.PI,!0),a.fill(),i}return t.cropper.getCroppedCanvas()}registerFileInputChangeEvent(){var e=this;return t(document).on("change",'form[action="/cart/add"] input[type="file"]',(function(i){if(e.inputDom=t(this),e.files=i.target.files,e.inputDom.val()){0!=e.inputDom.data("cropper")?e.initRectangleRatio().doCropper():e.addFile();var a="";a+='<div class="ymq-cropper-button ymq-cropper-rotate-left"><svg t="1625460890766" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6401" width="16" height="16"><path d="M950.930517 512q0 89.161143-34.889143 170.276571t-93.696 139.995429-139.995429 93.696-170.276571 34.889143q-98.304 0-186.88-41.398857t-150.820571-116.882286q-4.022857-5.705143-3.730286-12.873143t4.827429-11.702857l78.262857-78.848q5.705143-5.12 14.262857-5.12 9.142857 1.170286 13.165714 6.875429 41.691429 54.272 102.253714 83.968t128.585143 29.696q59.465143 0 113.444571-23.113143t93.403429-62.537143 62.537143-93.403429 23.113143-113.444571-23.113143-113.444571-62.537143-93.403429-93.403429-62.537143-113.444571-23.113143q-56.027429 0-107.446857 20.260571t-91.428571 58.002286l78.262857 78.848q17.700571 17.115429 7.972571 39.424-9.728 22.820571-33.718857 22.820571l-256 0q-14.848 0-25.746286-10.825143t-10.825143-25.746286l0-256q0-23.990857 22.820571-33.718857 22.308571-9.728 39.424 7.972571l74.313143 73.728q61.147429-57.709714 139.702857-89.453714t162.596571-31.744q89.161143 0 170.276571 34.889143t139.995429 93.696 93.696 139.995429 34.889143 170.276571z" p-id="6402" fill="#ffffff"></path></svg></div><div class="ymq-cropper-button ymq-cropper-rotate-right"><svg t="1625461123473" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6636" width="16" height="16"><path d="M950.857143 146.285714l0 256q0 14.857143-10.857143 25.714286t-25.714286 10.857143l-256 0q-24 0-33.714286-22.857143-9.714286-22.285714 8-39.428571l78.857143-78.857143q-84.571429-78.285714-199.428571-78.285714-59.428571 0-113.428571 23.142857t-93.428571 62.571429-62.571429 93.428571-23.142857 113.428571 23.142857 113.428571 62.571429 93.428571 93.428571 62.571429 113.428571 23.142857q68 0 128.571429-29.714286t102.285714-84q4-5.714286 13.142857-6.857143 8 0 14.285714 5.142857l78.285714 78.857143q5.142857 4.571429 5.428571 11.714286t-4.285714 12.857143q-62.285714 75.428571-150.857143 116.857143t-186.857143 41.428571q-89.142857 0-170.285714-34.857143t-140-93.714286-93.714286-140-34.857143-170.285714 34.857143-170.285714 93.714286-140 140-93.714286 170.285714-34.857143q84 0 162.571429 31.714286t139.714286 89.428571l74.285714-73.714286q16.571429-17.714286 40-8 22.285714 9.714286 22.285714 33.714286z" p-id="6637" fill="#ffffff"></path></svg></div>',e.modal.find(".ymq-img-action_m").append(a),e.modal.find(".ymq-img-action_pc").append(a)}})),e}doCropper(){var t,e,i=this;i.files&&i.files.length>0&&(t=i.files[0],/^image\/\w+/.test(t.type)?URL?i.done(URL.createObjectURL(t)):FileReader&&((e=new FileReader).onload=function(t){i.done(e.result)},e.readAsDataURL(t)):i.addFile())}done(t){var e=this;e.inputDom.val(""),e.imgDom.prop("src",t),e.modal.modal("show")}isDisabled(){var t=this,e=t.inputDom.prop("name"),i=t.inputDom.data("file-num"),a=0;t.fileData.hasOwnProperty(e)&&(a=Object.keys(t.fileData[e]).length),a>=i?t.inputDom.parents(".ymq_upload_new").addClass("ymq_disabled"):t.inputDom.parents(".ymq_upload_new").removeClass("ymq_disabled")}addFile(){var e=this,i="",a=e.inputDom.prop("name"),n=e.inputDom.parents(".ymq-options-box").find(".ymq_upload_img_view"),o=e.inputDom.parents(".ymq-options-box").find(".ymq_upload_file_view"),m=e.inputDom.data("file-num"),d=e.files.length,l="";e.fileData.hasOwnProperty(a)||(e.fileData[a]={}),(m-=Object.keys(e.fileData[a]).length)<=e.files.length&&(d=m);for(let m=0;m<d;m++)e.fileData[a][e.num]={file:e.files[m],name:e.files[m].name},/^image\/\w+/.test(e.files[m].type)?(URL&&(i=URL.createObjectURL(e.files[m])),l=`\n\t\t\t\t\t\t<div class="ymq_upload_img_item ymq_upload_file_item ymq_upload_file_item_${e.num}" style="display: none;" data-name="${a}" data-num="${e.num}">\n\t\t\t\t\t\t\t<img class="ymq_img_item" src="${i}" alt="">\n\t\t\t\t\t\t\t<div class="ymq_upload_img_item_bg">\n\t\t\t\t\t\t\t\t<span data-name="${a}" data-num="${e.num}" class="ymq_upload_img_item_del ymq_upload_file_item_del"></span>\n\t\t\t\t\t\t\t\t<div class="spotlight" data-src="${i}"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`,n.prepend(l),t(`.ymq_upload_file_item_${e.num}`).fadeIn()):(l=`\n\t\t\t\t\t\t<div class="ymq_upload_item ymq_upload_file_view ymq_upload_file_item ymq_upload_file_item_${e.num}">\n\t\t\t\t\t\t\t<div class="ymq_upload_type ymq_upload_img"></div>\n\t\t\t\t\t\t\t<div class="ymq_upload_name">${e.files[m].name}</div>\n\t\t\t\t\t\t\t<div data-name="${a}" data-num="${e.num}" class="ymq_upload_status ymq_upload_success ymq_upload_file_item_del"></div>\n\t\t\t\t\t\t\t<div class="ymq_clear_both"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t`,o.append(l),t(`.ymq_upload_file_item_${e.num}`).fadeIn()),e.num++;e.inputDom.val("").change(),e.isDisabled()}addImg(e){var i=this,a=URL.createObjectURL(e),n=i.inputDom.parents(".ymq-options-box").find(".ymq_upload_img_view"),o=i.inputDom.prop("name"),m=`\n\t\t\t\t<div class="ymq_upload_img_item ymq_upload_file_item ymq_upload_file_item_${i.num}" style="display: none;" data-name="${o}" data-num="${i.num}">\n\t\t\t\t\t<img class="ymq_img_item" src="${a}" alt="">\n\t\t\t\t\t<div class="ymq_upload_img_item_bg">\n\t\t\t\t\t\t<span data-name="${o}" data-num="${i.num}" class="ymq_upload_img_item_del ymq_upload_file_item_del"></span>\n\t\t\t\t\t\t<div class="spotlight" data-src="${a}"></div>\n\t\t\t\t\t</div>\n\t\t\t  \t</div>\n\t\t\t`;i.fileData.hasOwnProperty(o)||(i.fileData[o]={}),i.fileData[o][i.num]={file:e,name:`${o}_${i.num}.jpg`},i.formData.append(o,e,`${o}.jpg`),n.prepend(m),t(`.ymq_upload_file_item_${i.num}`).fadeIn(),i.modal.modal("hide"),i.num++,i.inputDom.val("").change(),i.isDisabled()}initModal(){var e=this;return t("body").append('\n\t\t\t\t<div class="ymq-bmodal ymq-modal-fade" id="ymqBootModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">\n\t\t\t\t\t<div class="ymq-modal-dialog ymq-modal-lg" role="document">\n\t\t\t\t\t  <div class="ymq-bmodal-content">\n\t\t\t\t\t\t<div class="ymq-modal-header">\n\t\t\t\t\t\t  <div class="ymq-modal-close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ymq-modal-body">\n\t\t\t\t\t\t  <div class="ymq-img-container">\n\t\t\t\t\t\t\t<div class="ymq-img-cropper-container">\n\t\t\t\t\t\t\t  <img id="ymq-upload-cropper-img" src="">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="ymq-img-review-container">\n\t\t\t\t\t\t\t  <div class="ymq-img-review">\n\t\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t\t  <div class="ymq-img-action ymq-img-action_m ymq_m_show">\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ymq-modal-footer">\n\t\t\t\t\t\t  <div class="ymq-cropper-button ymq-cropper-button-close" data-dismiss="modal">Close</div>\n\t\t\t\t\t\t  <div class="ymq-img-action ymq-img-action_pc ymq_pc_show">\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t  </div>\n\t\t\t\t\t\t  <div class="ymq-cropper-button" id="ymq-do-cropper">Save</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t  </div>\n\t\t\t\t\t</div>\n\t\t\t\t  </div>\n\t\t\t'),e.imgDom=t("#ymq-upload-cropper-img"),e.modal=t("#ymqBootModal"),e.modal.on("shown.bs.modal",(function(){e.newCropper()})).on("hidden.bs.modal",(function(){e.destroyCropper(),t(".ymq-img-review").html("")})),e}static getInstance(){return this.instance||(this.instance=new e),this.instance}}}));